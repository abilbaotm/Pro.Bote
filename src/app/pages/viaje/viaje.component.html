
<div class=" content">
  <div class="row">
      <div class=" col-12" *ngIf="!viaje.archivado && !viaje.borrado">
        <button routerLink="nuevogasto" class=" btn btn-link" type="button" >
          Nuevo gasto
        </button>
        <button routerLink="nuevopago" class=" btn btn-link" type="button" >
          Nuevo pago
        </button>
        <button routerLink="editarviaje" class=" btn btn-link" type="button" *ngIf="viaje.admin==user.uid">
          Editar
        </button>

      </div>
      <div class="col-12">
        <div class=" card card-stats">
          <div class=" card-body">
            <div class=" row">
              <div class=" col-12">
                <div *ngIf="viaje.borrado" class="alert alert-danger" role="alert">
                  Este viaje ha sido marcado para borrar. Desaparecera en unas horas. <a *ngIf="viaje.admin==user.uid" class="pointer" (click)="cancelarBorrado()">Cancelar</a>
                </div>
                <div *ngIf="viaje.archivado" class="alert alert-danger" role="alert">
                  Este viaje ha sido archivado. <a *ngIf="viaje.admin==user.uid" class="pointer" (click)="cancelarArchivado()">Cancelar</a>
                </div>
                <p class=" cart-title">{{viaje.descripcion}}</p>
                <p class=" card-description">Fechas: {{fechasInicio}} ->  {{fechasFin}}
                </p>
                <p class=" card-description">Usuarios permitidos:<br>
                  <span *ngFor="let usuario of viaje.permitidos | keyvalue">
                    - {{usuario.value["nombre"]}} <{{usuario["key"]}}> <span *ngIf="usuario.value['owner']" class="label label-primary">Creador</span><br>
                  </span>
                </p>
                <p class=" card-description">Participantes:<br>
                  <span *ngFor="let persona of personas">
                    - {{persona.nombre}} <{{persona.email | lowercase}}> <br>
                  </span>
                </p>
              </div>
            </div>
          </div>
        </div>
      </div>
    <div class="col-12">

      <div class=" card card-stats">
        <div class=" card-body">
          <div class=" row">
            <div class=" col-12">
              <h3>Gastos</h3>

              <mat-accordion  class="my-headers-align">
                <mat-expansion-panel *ngFor="let gasto of gastos" class="py-2">
                  <mat-expansion-panel-header style="min-height: 30px" [collapsedHeight]="'auto'" [expandedHeight]="'auto'">
                    <ng-container *ngIf="false">
                    <mat-panel-title>
                      {{gasto.descripcion}}
                    </mat-panel-title>
                    <mat-panel-description>
                      {{gasto.diaLocal }}
                    </mat-panel-description>
                    <mat-panel-description>
                      <p>{{gasto.cantidad | number : '0.2-2'}} {{gasto.moneda}}</p>
                      <p class="text-right ml-1" *ngIf="gasto.moneda != viaje.monedaPrincipal || gasto.ratio != 1"> ({{(gasto.cantidad / gasto.ratio) | number : '0.2-2'}} {{viaje.monedaPrincipal}}) </p>
                    </mat-panel-description>
                    </ng-container>
                    <div class="row w-100">
                      <div class="col-md-6 m-auto">{{gasto.descripcion}}</div>
                      <div class="col-md-2 m-auto"><p class="m-auto">{{gasto.diaLocal}}</p></div>
                      <div class="col-md-4 m-auto">
                        <p class="m-auto">
                        {{gasto.cantidad | number : '0.2-2'}} {{gasto.moneda}}
                          <span class="text-right ml-1" *ngIf="gasto.moneda != viaje.monedaPrincipal || gasto.ratio != 1"> ({{(gasto.cantidad / gasto.ratio) | number : '0.2-2'}} {{viaje.monedaPrincipal}}) </span></p>
                      </div>
                    </div>


                  </mat-expansion-panel-header>

                  <ng-template matExpansionPanelContent>
                    <div class="row pt-3">
                      <div class="col-md-6">
                        <p>Descripción: {{gasto.descripcion}}</p>
                        <p>Fecha: {{gasto.fechaLocal}} ({{gasto.timezone}}) </p>
                        <ng-container *ngIf="gasto.moneda != viaje.monedaPrincipal || gasto.ratio != 1">
                          <p>Cantidad (Moneda extranjera): {{gasto.cantidad | number : '0.2-2'}} {{gasto.moneda}}</p>
                          <p>Cantidad (Moneda principal): {{(gasto.cantidad / gasto.ratio) | number : '0.2-2'}} {{viaje.monedaPrincipal}}</p>
                          <p>Ratio de cambio: {{gasto.ratio | number : '0.3-3'}}</p>
                        </ng-container>
                        <ng-container  *ngIf="gasto.moneda == viaje.monedaPrincipal || gasto.ratio == 1">
                          <p>Cantidad: {{gasto.cantidad | number : '0.2-2'}} {{gasto.moneda}}</p>
                        </ng-container>

                        <p>Pagado por: {{personasIndex[gasto.pagador]}}</p>
                        <p>Partes iguales: {{gasto.partesIguales?'Sí':'No'}}</p>
                      </div>
                      <div class="col-md-6">
                        <table mat-table [dataSource]="gasto.personas | keyvalue" class="mat-elevation-z8 w-100">

                          <ng-container matColumnDef="persona">
                            <td mat-cell *matCellDef="let element"> {{personasIndex[element.key]}} </td>
                          </ng-container>
                          <ng-container matColumnDef="cantidad">
                            <td mat-cell *matCellDef="let element"> {{element.value.cantidad | number : '0.2-2'}} {{gasto.moneda}}
                              <span *ngIf="gasto.moneda != viaje.monedaPrincipal || gasto.ratio != 1">
                                ({{element.value.cantidad / gasto.ratio | number : '0.2-2'}} {{viaje.monedaPrincipal}})
                              </span>
                            </td>
                          </ng-container>

                          <tr mat-row *matRowDef="let row; columns: ['persona', 'cantidad'];"></tr>
                        </table>

                      </div>

                    </div>
                  </ng-template>

                </mat-expansion-panel>
              </mat-accordion>

            </div>
          </div>
        </div>
      </div>
    </div>


    <div class="col-12">

      <div class=" card card-stats">
        <div class=" card-body">
          <div class=" row">
            <div class=" col-12">
              <h3>Pagos</h3>
              <h4>Cuentas pendientes</h4>

              <ul class="nav nav-tabs" id="myTab" role="tablist">
                <li class="nav-item" *ngFor="let persona of personas">
                  <a [className]="idPersonaCuentasActiva!=persona.id ? 'nav-link' : 'nav-link active'" id="home-tab" data-toggle="tab" role="tab" aria-controls="home" aria-selected="true" (click)="verCuentasPersona(persona.id)">{{persona.nombre}}</a>
                </li>
              </ul>

              <p>Cuentas pendientes de todos los participantes a {{personasIndex[idPersonaCuentasActiva]}}...</p>
              <table style="width: 100%">
                <tr>
                  <th></th>
                  <th>Total debido por pago de gastos</th>
                  <th>Total habido por pago de gastos</th>
                  <th>Balance pagos por gastos</th>
                  <th>Balance pagos directos</th>
                  <th>Pendiente de pago</th>
                </tr>
                <ng-container *ngIf="false && idPersonaCuentasActiva">
                  <ng-container *ngFor="let perso of personas">
                    <tr *ngIf="perso.id != idPersonaCuentasActiva">
                      <td>{{perso.nombre}}</td>
                      <td *ngIf="resumenPagos[idPersonaCuentasActiva]">{{resumenPagos[idPersonaCuentasActiva].debe[perso.id] | number : '0.2-2'}} {{viaje.monedaPrincipal}}</td>
                      <td *ngIf="resumenPagos[idPersonaCuentasActiva]">{{resumenPagos[idPersonaCuentasActiva].pagos[perso.id] | number : '0.2-2'}} {{viaje.monedaPrincipal}}</td>
                      <td *ngIf="resumenPagos[idPersonaCuentasActiva]">{{resumenPagos[idPersonaCuentasActiva].debe[perso.id] - resumenPagos[idPersonaCuentasActiva].pagos[perso.id] | number : '0.2-2'}} {{viaje.monedaPrincipal}}</td>
                    </tr>
                  </ng-container>
                </ng-container>



                <ng-container *ngIf="idPersonaCuentasActiva">
                  <ng-container *ngFor="let perso of personas">
                    <tr *ngIf="perso.id != idPersonaCuentasActiva">
                      <td>{{perso.nombre}}</td>
                      <td *ngIf="resumenPagos[idPersonaCuentasActiva]">{{resumenPagos[idPersonaCuentasActiva].debe[perso.id] | number : '0.2-2'}} {{viaje.monedaPrincipal}}</td>
                      <td *ngIf="resumenPagos[idPersonaCuentasActiva]">{{resumenPagos[perso.id].debe[idPersonaCuentasActiva] | number : '0.2-2'}} {{viaje.monedaPrincipal}}</td>
                      <td *ngIf="resumenPagos[idPersonaCuentasActiva]">{{resumenPagos[idPersonaCuentasActiva].debe[perso.id] - resumenPagos[perso.id].debe[idPersonaCuentasActiva] | number : '0.2-2'}} {{viaje.monedaPrincipal}}</td>
                      <td *ngIf="resumenPagos[idPersonaCuentasActiva]">{{resumenPagos[idPersonaCuentasActiva].pagos[perso.id] - resumenPagos[perso.id].pagos[idPersonaCuentasActiva] | number : '0.2-2'}} {{viaje.monedaPrincipal}}</td>
                      <td *ngIf="resumenPagos[idPersonaCuentasActiva]">{{(resumenPagos[idPersonaCuentasActiva].debe[perso.id] - resumenPagos[perso.id].debe[idPersonaCuentasActiva] ) - (resumenPagos[idPersonaCuentasActiva].pagos[perso.id] - resumenPagos[perso.id].pagos[idPersonaCuentasActiva])| number : '0.2-2'}} {{viaje.monedaPrincipal}}</td>
                    </tr>
                  </ng-container>
                </ng-container>
              </table>

              <p>* Los importes son mostrados en {{viaje.monedaPrincipal}}. Ratio de conversión de divisa aplicado. Este resumen está sujeto a cambios por ratio de divisa.</p>
              <br>

              <h4>Historico pagos</h4>
              <table style="width: 100%">
                <tr>
                  <th>Pagador</th>
                  <th>Beneficiario</th>
                  <th>Nota</th>
                  <th>Cantidad</th>
                  <th>Cantidad Moneda Principal</th>
                  <th>Fecha</th>
                </tr>
                <tr *ngFor="let pago of pagos">
                  <td>{{personasIndex[pago.pagador]}}</td>
                  <td>{{personasIndex[pago.beneficiario]}}</td>
                  <td>{{pago.nota}}</td>
                  <td>{{pago.cantidad | number : '0.2-2'}} {{pago.moneda}}</td>
                  <td>{{(pago.cantidad / pago.ratio) | number : '0.2-2'}} {{viaje.monedaPrincipal}}</td>
                  <td>{{pago.fechaLocal }}</td>
                </tr>
              </table>
            </div>
          </div>
        </div>
      </div>
    </div>


  </div>



</div>
