image: node:13

prerequisites:
  stage: .pre
  cache:
    paths:
      - node_modules/
  script:
    - npm install --quiet
  except:
    variables:
      - $CI_COMMIT_MESSAGE =~ /skip-ci/

build_web:
  stage: build
  dependencies:
    - prerequisites
  cache:
    paths:
      - node_modules/
  script:
    - npm run build-prod
  artifacts:
    paths:
      - dist/
  except:
    variables:
      - $CI_COMMIT_MESSAGE =~ /skip-ci/

#test:
#  stage: test
#  cache:
#    policy: pull
#    paths:
#      - node_modules/
#  script:
#    # install dependencies to use chrome w/ puppeteer
#    - apt update && apt install -yq gconf-service libasound2 libatk1.0-0 libc6 libcairo2 libcups2 libdbus-1-3 libexpat1 libfontconfig1 libgcc1 libgconf-2-4 libgdk-pixbuf2.0-0 libglib2.0-0 libgtk-3-0 libnspr4 libpango-1.0-0 libpangocairo-1.0-0 libstdc++6 libx11-6 libx11-xcb1 libxcb1 libxcomposite1 libxcursor1 libxdamage1 libxext6 libxfixes3 libxi6 libxrandr2 libxrender1 libxss1 libxtst6 ca-certificates fonts-liberation libappindicator1 libnss3 lsb-release xdg-utils wget
#    - npm run test-ci
#    - npm run e2e-ci
#  except:
#    variables:
#      - $CI_COMMIT_MESSAGE =~ /skip-ci/

deploy_prod:
  stage: deploy
  environment:
    name: production
    url: $FIREBASE_URL
  only:
    - master
  dependencies:
    - build_web
  cache:
    policy: pull
    paths:
      - node_modules/
  script:
    - cd functions && npm install && cd -
    - npm run deploy
  except:
    variables:
      - $CI_COMMIT_MESSAGE =~ /skip-ci/

build_android:
  stage: build
  dependencies:
    - prerequisites
  cache:
    paths:
      - node_modules/
  variables:
    ANDROID_COMPILE_SDK: "26"
    ANDROID_BUILD_TOOLS: "28.0.3"
  script:
    - wget --quiet --output-document=android-sdk.zip https://dl.google.com/android/repository/sdk-tools-linux-3859397.zip
    - unzip -q android-sdk.zip -d android-sdk-linux
    - export ANDROID_SDK_ROOT=$PWD/android-sdk-linux
    - export PATH=$PATH:$PWD/android-sdk-linux/platform-tools/
    - apt-get update; apt-get install openjdk-8-jdk gradle -y
    - android-sdk-linux/tools/bin/sdkmanager --update > update.log
    - echo y | android-sdk-linux/tools/bin/sdkmanager "platforms;android-${ANDROID_COMPILE_SDK}" >/dev/null
    - echo y | android-sdk-linux/tools/bin/sdkmanager "platform-tools" >/dev/null
    - echo y | android-sdk-linux/tools/bin/sdkmanager "build-tools;${ANDROID_BUILD_TOOLS}" >/dev/null
    - set +o pipefail
    - yes | android-sdk-linux/tools/bin/sdkmanager --licenses
    - set -o pipefail
    - node_modules/.bin/ng build --prod --base-href . --output-path CordovaMobileApp/www/
    - cd CordovaMobileApp
    #FICHEROS PARA FIRMAR
    - echo $RELEASE_KEYSTORE_BASE64 | base64 -d > android.jks
    - cp $BUILD_JSON build.json
    - cp $GOOGLE_SERVICES google-services.json
    - npm install --quiet
    - ../node_modules/.bin/cordova platform add android
    - ../node_modules/.bin/cordova build android
  artifacts:
    paths:
      - CordovaMobileApp/platforms/android/app/build/outputs/apk/
